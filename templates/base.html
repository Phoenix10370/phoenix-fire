<!-- templates/base.html (FULL FILE REPLACEMENT) -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Phoenix Fire Main Database</title>

  <!-- Bootstrap 5 -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

  <!-- Bootstrap Icons -->
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">

  <style>
    .page-wrap { animation: pageEnter 160ms ease-out; }
    @keyframes pageEnter {
      from { opacity: 0; transform: translateX(8px); }
      to   { opacity: 1; transform: translateX(0); }
    }

    body.page-exit .page-wrap {
      opacity: 0;
      transform: translateX(-14px);
      transition: opacity 140ms ease, transform 140ms ease;
    }

    @media (prefers-reduced-motion: reduce) {
      .page-wrap { animation: none; }
      body.page-exit .page-wrap { transition: none; }
    }

    .btn-back,
    a.btn-back,
    button.btn-back {
      background-color: var(--bs-success) !important;
      border-color: var(--bs-success) !important;
      color: #fff !important;
      padding: 0.6rem 1.25rem;
      font-size: 1.05rem;
    }

    .btn-back:hover { filter: brightness(0.95); }

    .print-only { display: none; }

    @media print {
      nav.navbar,
      .no-print { display: none !important; }
      body { background: #fff !important; }
      main.container { margin: 0 !important; padding: 0 !important; }
      .page-wrap { animation: none !important; }
      .print-only { display: block !important; }
    }
  </style>
</head>

<body class="bg-light">

<!-- NAV BAR -->
<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
  <div class="container">

    <!-- BRAND -->
    <a class="navbar-brand fw-semibold d-flex align-items-center gap-2"
       href="{% url 'dashboard' %}">
      {% if client_profile and client_profile.company_logo %}
        <img src="{{ client_profile.company_logo.url }}"
             alt="Company Logo"
             style="height:32px;width:auto;"
             class="rounded bg-white p-1">
      {% endif %}
      <span>Phoenix Fire Main Database</span>
    </a>

    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#mainNav">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div class="collapse navbar-collapse" id="mainNav">

      {% with rp=request.resolver_match %}
      {% with ns=rp.namespace|default_if_none:"" urlname=rp.url_name|default_if_none:"" %}

      <!-- LEFT NAV -->
      <ul class="navbar-nav me-auto">

        <!-- Dashboard -->
        <li class="nav-item">
          <a class="nav-link {% if urlname == 'dashboard' %}active{% endif %}"
             href="{% url 'dashboard' %}">
            Dashboard
          </a>
        </li>

        <!-- CUSTOMERS -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle {% if ns == 'customers' %}active{% endif %}"
             href="#" data-bs-toggle="dropdown">
            Customers
          </a>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item {% if ns == 'customers' and urlname == 'list' %}active{% endif %}"
                 href="{% url 'customers:list' %}">
                <i class="bi bi-people me-2"></i>Customer List
              </a>
            </li>
            <li>
              <a class="dropdown-item {% if ns == 'customers' and urlname == 'create' %}active{% endif %}"
                 href="{% url 'customers:create' %}">
                <i class="bi bi-person-plus me-2"></i>Add Customer
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item {% if ns == 'customers' and urlname == 'import' %}active{% endif %}"
                 href="{% url 'customers:import' %}">
                <i class="bi bi-upload me-2"></i>Import Customers
              </a>
            </li>
          </ul>
        </li>

        <!-- PROPERTIES -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle
             {% if ns == 'properties' or ns == 'routines' or ns == 'job_tasks' or ns == 'quotations' %}active{% endif %}"
             href="#" data-bs-toggle="dropdown">
            Properties
          </a>
          <ul class="dropdown-menu">
            <li>
              <a class="dropdown-item {% if ns == 'properties' and urlname == 'list' %}active{% endif %}"
                 href="{% url 'properties:list' %}">
                <i class="bi bi-buildings me-2"></i>Property List
              </a>
            </li>
            <li><hr class="dropdown-divider"></li>
            <li>
              <a class="dropdown-item {% if ns == 'routines' and urlname == 'list' %}active{% endif %}"
                 href="{% url 'routines:list' %}">
                <i class="bi bi-arrow-repeat me-2"></i>Routines
              </a>
            </li>
            <li>
              <a class="dropdown-item {% if ns == 'job_tasks' and urlname == 'list' %}active{% endif %}"
                 href="{% url 'job_tasks:list' %}">
                <i class="bi bi-clipboard-check me-2"></i>Job Tasks
              </a>
            </li>
            <li>
              <a class="dropdown-item {% if ns == 'quotations' and urlname == 'list' %}active{% endif %}"
                 href="{% url 'quotations:list' %}">
                <i class="bi bi-receipt me-2"></i>Quotations
              </a>
            </li>
          </ul>
        </li>

        <!-- SETTINGS -->
        <li class="nav-item dropdown">
          <a class="nav-link dropdown-toggle
             {% if ns == 'codes' or ns == 'company' or ns == 'email_templates' %}active{% endif %}"
             href="#" data-bs-toggle="dropdown">
            Settings
          </a>
          <ul class="dropdown-menu">

            <li class="dropdown-header text-uppercase small text-muted">Codes</li>

            <li>
              <a class="dropdown-item {% if urlname == 'efsm_list' %}active{% endif %}"
                 href="{% url 'codes:efsm_list' %}">
                <i class="bi bi-shield-check me-2"></i>EFSM Codes
              </a>
            </li>

            <li>
              <a class="dropdown-item {% if urlname == 'defect_list' %}active{% endif %}"
                 href="{% url 'codes:defect_list' %}">
                <i class="bi bi-exclamation-triangle me-2"></i>Defect Codes
              </a>
            </li>

            <li>
              <a class="dropdown-item {% if urlname == 'asset_list' %}active{% endif %}"
                 href="{% url 'codes:asset_list' %}">
                <i class="bi bi-box-seam me-2"></i>Asset Codes
              </a>
            </li>

            <li>
              <a class="dropdown-item {% if urlname == 'dropdown_list_list' %}active{% endif %}"
                 href="{% url 'codes:dropdown_list_list' %}">
                <i class="bi bi-list-check me-2"></i>Dropdown Lists
              </a>
            </li>

            <li><hr class="dropdown-divider"></li>

            <li class="dropdown-header text-uppercase small text-muted">Main Database</li>

            <li>
              <a class="dropdown-item {% if ns == 'company' and urlname == 'client_profile' %}active{% endif %}"
                 href="{% url 'company:client_profile' %}">
                <i class="bi bi-building me-2"></i>Client
              </a>
            </li>

            <li>
              <a class="dropdown-item {% if ns == 'email_templates' and urlname == 'list' %}active{% endif %}"
                 href="{% url 'email_templates:list' %}">
                <i class="bi bi-envelope-paper me-2"></i>Email Templates
              </a>
            </li>

          </ul>
        </li>

        <!-- Scheduling -->
        <li class="nav-item">
          <a class="nav-link {% if ns == 'scheduling' %}active{% endif %}"
             href="{% url 'scheduling:index' %}">
            <i class="bi bi-calendar-week me-1"></i>Scheduling
          </a>
        </li>

      </ul>

      {% endwith %}
      {% endwith %}

      <!-- RIGHT NAV -->
      <ul class="navbar-nav">
        {% if user.is_authenticated %}
          <li class="nav-item">
            <span class="navbar-text me-3">Logged in as {{ user.username }}</span>
          </li>
          <li class="nav-item">
            <a class="btn btn-outline-light btn-sm" href="/admin/logout/">Logout</a>
          </li>
        {% else %}
          <li class="nav-item">
            <a class="btn btn-outline-light btn-sm" href="/admin/login/">Login</a>
          </li>
        {% endif %}
      </ul>

    </div>
  </div>
</nav>

<!-- PAGE CONTENT -->
<main class="container my-4 page-wrap">

  <div class="mb-3 no-print">
    <button type="button" class="btn btn-back btn-sm"
            onclick="goBackAnimated()" title="Back">
      <i class="bi bi-arrow-left"></i>
    </button>
  </div>

  <!-- DJANGO MESSAGES -->
  {% if messages %}
    <div class="no-print mb-3">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags|default:'info' }} alert-dismissible fade show shadow-sm mb-2" role="alert">
          {{ message }}
          <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  {% block content %}{% endblock %}

</main>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

<script>
  function goBackAnimated() {
    const dashboardUrl = "{% url 'dashboard' %}";
    if (!document.referrer) {
      window.location.href = dashboardUrl;
      return;
    }
    document.body.classList.add("page-exit");
    setTimeout(() => window.history.back(), 150);
  }
</script>

<!-- UNSAVED CHANGES WARNING (GLOBAL) -->
<script>
  (function () {
    const forms = document.querySelectorAll("form");
    if (!forms.length) return;

    let isDirty = false;
    let isSubmitting = false;

    forms.forEach((form) => {
      if (form.hasAttribute("data-skip-unsaved-warning")) return;

      const method = (form.getAttribute("method") || "get").toLowerCase();
      if (method === "get") return;

      const fields = form.querySelectorAll("input, textarea, select");

      fields.forEach((field) => {
        field.addEventListener("input", () => { isDirty = true; }, { passive: true });
        field.addEventListener("change", () => { isDirty = true; }, { passive: true });
      });

      form.addEventListener("submit", () => {
        isSubmitting = true;
      });
    });

    window.addEventListener("beforeunload", (e) => {
      if (!isDirty || isSubmitting) return;
      e.preventDefault();
      e.returnValue = "";
    });
  })();
</script>

</body>
</html>
