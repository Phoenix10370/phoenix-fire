{% extends "base.html" %}

{% block content %}
<div class="container-fluid py-3">

  <div class="row g-3 align-items-end mb-2">
    <div class="col-lg-9">
      <div class="d-flex flex-wrap gap-2 align-items-center">
        <div class="me-auto">
          <h4 class="mb-0">Scheduling</h4>
          <div class="text-muted small">Drag unallocated works into the calendar to schedule them.</div>
        </div>

        <div style="min-width: 280px;" class="no-print">
          <label class="form-label mb-1"><strong>Technician</strong></label>
          <select id="technicianFilter" class="form-select form-select-sm">
            <option value="">All technicians</option>
            {% for tech in technicians %}
              <option value="{{ tech.id }}">{{ tech.username }}</option>
            {% endfor %}
          </select>
        </div>
      </div>
    </div>

    <div class="col-lg-3">
      <label class="form-label mb-1"><strong>Filter (Service Type)</strong></label>
      <div class="input-group">
        <input id="serviceTypeFilter" class="form-control form-control-sm" placeholder="Type name or ID (e.g. 12)" />
        <input id="dateFilter" class="form-control form-control-sm" type="date" />
        <button id="applyFilter" class="btn btn-outline-secondary btn-sm" type="button">Search</button>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-lg-9">
      <div class="card">
        <div class="card-body">
          <div id="calendar"></div>
          <div id="listGroupedContainer" class="mt-2" style="display:none;"></div>
        </div>
      </div>
    </div>

    <div class="col-lg-3">
      <div class="card">
        <div class="card-header d-flex align-items-center justify-content-between">
          <strong>Unallocated Works</strong>
        </div>
        <div class="card-body">
          <div id="unallocatedDropZone" class="border rounded p-2 mb-2 bg-light">
            <div class="small text-muted">
              Drop a scheduled job here to unallocate (clears date/time)
            </div>
          </div>

          <div id="unallocatedList" class="small" style="max-height: 62vh; overflow:auto;">
            <!-- injected (grouped by technician) -->
          </div>

          <div class="text-muted small mt-2">
            Tip: drag an item onto the calendar to schedule it.
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<style>
  .fc-event.is-saving { opacity: 0.6; pointer-events: none; }

  .list-grouped-section { margin-bottom: 1rem; }
  .list-grouped-header { font-weight: 600; text-transform: uppercase; color: #6c757d; font-size: 0.75rem; margin-bottom: 0.25rem; }
  .list-grouped-item { border: 1px solid #dee2e6; border-radius: 0.375rem; padding: 0.5rem 0.75rem; margin-bottom: 0.5rem; background: #fff; }
  .list-grouped-time { font-size: 0.8rem; color: #6c757d; }

</style>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.css">
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.20/index.global.min.js"></script>

<script>
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }
  const csrftoken = getCookie('csrftoken');

  // ✅ Convert a JS Date to timezone-free ISO: "YYYY-MM-DDTHH:MM:SS"
  function toNaiveLocalISO(dateObj) {
    const pad = (n) => String(n).padStart(2, "0");
    const y = dateObj.getFullYear();
    const m = pad(dateObj.getMonth() + 1);
    const d = pad(dateObj.getDate());
    const hh = pad(dateObj.getHours());
    const mm = pad(dateObj.getMinutes());
    const ss = pad(dateObj.getSeconds());
    return `${y}-${m}-${d}T${hh}:${mm}:${ss}`;
  }

  async function postJSON(url, body) {
    const res = await fetch(url, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": csrftoken,
        "Accept": "application/json"
      },
      body: JSON.stringify(body || {}),
      keepalive: true  // ✅ IMPORTANT: still sends even if you navigate away
    });

    if (!res.ok) {
      const txt = await res.text();
      throw new Error(txt || "Request failed");
    }
    return res.json();
  }

  function getTechnicianLabel(item) {
    if (item.technician_name) return item.technician_name;
    if (item.technician) {
      if (typeof item.technician === "string") return item.technician;
      if (typeof item.technician === "object") {
        return item.technician.username || item.technician.name || "Unassigned";
      }
    }
    if (item.service_technician) {
      if (typeof item.service_technician === "string") return item.service_technician;
      if (typeof item.service_technician === "object") {
        return item.service_technician.username || item.service_technician.name || "Unassigned";
      }
    }
    return "Unassigned";
  }

  async function loadUnallocated(serviceType="", dateStr="") {
    const url = new URL("{% url 'scheduling:unallocated_feed' %}", window.location.origin);
    if (serviceType) url.searchParams.set("service_type", serviceType);
    if (dateStr) url.searchParams.set("date", dateStr);

    const res = await fetch(url.toString(), { headers: { "Accept": "application/json" } });
    const items = await res.json();

    const container = document.getElementById("unallocatedList");
    container.innerHTML = "";

    // Group by technician label
    const groups = new Map();
    for (const item of items) {
      const label = getTechnicianLabel(item);
      if (!groups.has(label)) groups.set(label, []);
      groups.get(label).push(item);
    }

    const labels = Array.from(groups.keys()).sort((a, b) => a.localeCompare(b));

    for (const label of labels) {
      const section = document.createElement("div");
      section.className = "mb-3";

      const header = document.createElement("div");
      header.className = "fw-semibold small text-uppercase text-muted mb-1";
      header.textContent = label;

      const list = document.createElement("div");
      list.className = "list-group small";

      section.appendChild(header);
      section.appendChild(list);
      container.appendChild(section);

      for (const item of groups.get(label)) {
        const el = document.createElement("div");
        el.className = "list-group-item list-group-item-action";
        el.setAttribute("data-job-task-id", item.job_task_id);

        el.fcEventData = {
          id: item.job_task_id,
          title: item.title,
          duration: { minutes: item.durationMinutes || 60 },
          allDay: false,
          extendedProps: { job_task_id: item.job_task_id }
        };

        el.addEventListener("click", () => {
          window.location.href = `/job-tasks/${item.job_task_id}/`;
        });

        el.innerHTML = `
          <div class="fw-semibold">${item.title}</div>
          <div class="text-muted">${item.service_type || ""}</div>
        `;
        list.appendChild(el);
      }

      new FullCalendar.Draggable(list, {
        itemSelector: '.list-group-item',
        eventData: function(eventEl) { return eventEl.fcEventData; }
      });
    }
  }

  function openJobEdit(jobTaskId) {
    window.location.href = `/job-tasks/${jobTaskId}/edit/`;
  }

  function markSaving(event, saving) {
    event.setExtendedProp("_saving", !!saving);
    if (event._def && event._def.ui && event._def.ui.classNames) {
      // no-op; handled in eventDidMount below
    }
  }

  function wireUnallocateDropZone(dropZone, calendar) {
    dropZone.addEventListener("dragover", (e) => {
      e.preventDefault();
      e.dataTransfer.dropEffect = "move";
    });

    dropZone.addEventListener("drop", async (e) => {
      e.preventDefault();
      const jobTaskId = e.dataTransfer.getData("text/plain");
      if (!jobTaskId) return;

      try {
        await postJSON(
          `{% url 'scheduling:unschedule_jobtask' 0 %}`.replace("/0/", `/${jobTaskId}/`),
          {}
        );

        await loadUnallocated(document.getElementById("serviceTypeFilter").value.trim());
        calendar.refetchEvents();
        renderGroupedList(calendar);
      } catch (err) {
        alert("Could not unallocate: " + err.message);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', async function() {
    await loadUnallocated("");

    document.getElementById("applyFilter").addEventListener("click", () => {
      loadUnallocated(
        document.getElementById("serviceTypeFilter").value.trim(),
        document.getElementById("dateFilter").value
      );
      calendar.refetchEvents();
    });

    const technicianFilter = document.getElementById("technicianFilter");
    const calendarEl = document.getElementById('calendar');
    const dropZone = document.getElementById("unallocatedDropZone");

    const calendar = new FullCalendar.Calendar(calendarEl, {
      initialView: 'listDay',
      height: "auto",
      nowIndicator: true,
      editable: true,
      droppable: true,
      timeZone: 'local',
      allDaySlot: false,

      slotMinTime: "06:00:00",
      slotMaxTime: "19:00:00",

      headerToolbar: {
        left: 'prev,next today',
        center: 'title',
        right: 'dayGridMonth,timeGridWeek,timeGridDay,listDay'
      },

      dateClick: function(info) {
        calendar.changeView('timeGridDay', info.dateStr);
      },

      eventClick: function(info) {
        if (info.event.extendedProps._saving) {
          alert("Saving schedule... please wait 1 second then click again.");
          return;
        }
        const jobTaskId = info.event.extendedProps.job_task_id || info.event.id;
        window.location.href = `/job-tasks/${jobTaskId}/`;
      },

      eventContent: function(info) {
        const title = info.event.title || "Job Task";
        const time = info.timeText ? `${info.timeText} ` : "";
        const jobId = info.event.extendedProps.job_task_id || info.event.id || "";
        const serviceType = info.event.extendedProps.service_type || info.event.extendedProps.serviceType || "";

        if (info.view.type === "timeGridDay") {
          const tech = info.event.extendedProps.technician || "";
          const techLabel = String(tech).trim();
          const html = techLabel
            ? `<div>${time}${title}</div><div>${techLabel}</div>`
            : `<div>${time}${title}</div>`;
          return { html: html };
        }

        if (info.view.type === "dayGridMonth") {
          const rawType = String(serviceType || "").trim();
          const typeLower = rawType.toLowerCase();
          let shortType = rawType;

          if (typeLower === "annual inspection") {
            shortType = "Annual";
          } else if (typeLower === "bi-annual inspection" || typeLower === "bi annual inspection") {
            shortType = "Bi-Annual";
          } else if (typeLower === "monthly inspection") {
            shortType = "Monthly";
          } else if (typeLower === "quarterly inspection") {
            shortType = "Quarterly";
          } else if (rawType) {
            shortType = rawType.replace(/\s*inspection\s*$/i, "").trim() || rawType;
          }

          const label = shortType ? `#${jobId} - ${shortType}` : `#${jobId}`;
          return { html: label };
        }

        if (info.view.type === "timeGridWeek") {
          const label = serviceType
            ? `${serviceType} - ${info.timeText} - #${jobId}`
            : `${title} - ${info.timeText} - #${jobId}`;
          return { html: label };
        }

        return { html: `${time}${title}` };
      },

      eventDidMount: function(info) {
        info.el.style.cursor = "pointer";
        if (info.event.extendedProps._saving) {
          info.el.classList.add("is-saving");
        } else {
          info.el.classList.remove("is-saving");
        }

        const eventColor = info.event.extendedProps.event_color || "";
        if (info.view.type === "dayGridMonth") {
          info.el.style.backgroundColor = "";
          info.el.style.borderColor = "";
        } else if (eventColor) {
          info.el.style.backgroundColor = eventColor;
          info.el.style.borderColor = eventColor;
        }

        if ((info.view.type === "timeGridWeek" || info.view.type === "dayGridMonth") && window.bootstrap && window.bootstrap.Popover) {
          const serviceType = info.event.extendedProps.service_type || "";
          const jobId = info.event.extendedProps.job_task_id || info.event.id || "";
          const siteAddress = info.event.extendedProps.site_address || "";
          let timeText = "";
          if (info.event.start) {
            const start = info.event.start.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" });
            const end = info.event.end
              ? info.event.end.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" })
              : "";
            timeText = end ? `${start} - ${end}` : start;
          }

          const content = `
            <div><strong>Time</strong>: ${timeText || "—"}</div>
            <div><strong>Service Type</strong>: ${serviceType || "—"}</div>
            <div><strong>Job ID</strong>: #${jobId}</div>
            <div><strong>Site Address</strong>: ${siteAddress || "—"}</div>
          `;

          info.el._jtPopover = new window.bootstrap.Popover(info.el, {
            trigger: "hover focus",
            html: true,
            container: "body",
            content: content,
            placement: "auto",
          });
        }
      },

      eventWillUnmount: function(info) {
        if (info.el && info.el._jtPopover) {
          info.el._jtPopover.dispose();
          info.el._jtPopover = null;
        }
      },

      events: {
        url: "{% url 'scheduling:events_feed' %}",
        method: "GET",
        extraParams: function() {
          return {
            technician: technicianFilter.value || "",
            date: document.getElementById("dateFilter").value || ""
          };
        }
      },

      // ✅ unallocated -> calendar
      eventReceive: async function(info) {
        const jobTaskId = info.event.extendedProps.job_task_id || info.event.id;

        try {
          markSaving(info.event, true);

          if (!info.event.end) {
            info.event.setEnd(new Date(info.event.start.getTime() + 60 * 60000));
          }

          const startLocal = toNaiveLocalISO(info.event.start);
          const endLocal = toNaiveLocalISO(info.event.end);

          await postJSON(
            `{% url 'scheduling:schedule_jobtask' 0 %}`.replace("/0/", `/${jobTaskId}/`),
            { start: startLocal, end: endLocal, allDay: false }
          );

          markSaving(info.event, false);

          await loadUnallocated(document.getElementById("serviceTypeFilter").value.trim());
          calendar.refetchEvents();

          // open edit so technician can be set
          openJobEdit(jobTaskId);

        } catch (e) {
          markSaving(info.event, false);
          alert("Could not schedule item: " + e.message);
          info.revert();
        }
      },

      // ✅ move scheduled event
      eventDrop: async function(info) {
        try {
          markSaving(info.event, true);

          if (!info.event.end) {
            info.event.setEnd(new Date(info.event.start.getTime() + 60 * 60000));
          }

          const startLocal = toNaiveLocalISO(info.event.start);
          const endLocal = toNaiveLocalISO(info.event.end);

          await postJSON(
            `{% url 'scheduling:update_jobtask_times' 0 %}`.replace("/0/", `/${info.event.id}/`),
            { start: startLocal, end: endLocal, allDay: false }
          );

          markSaving(info.event, false);
          calendar.refetchEvents();

        } catch (e) {
          markSaving(info.event, false);
          alert("Could not update schedule: " + e.message);
          info.revert();
        }
      },

      // ✅ resize scheduled event
      eventResize: async function(info) {
        try {
          markSaving(info.event, true);

          if (!info.event.end) {
            info.event.setEnd(new Date(info.event.start.getTime() + 60 * 60000));
          }

          const startLocal = toNaiveLocalISO(info.event.start);
          const endLocal = toNaiveLocalISO(info.event.end);

          await postJSON(
            `{% url 'scheduling:update_jobtask_times' 0 %}`.replace("/0/", `/${info.event.id}/`),
            { start: startLocal, end: endLocal, allDay: false }
          );

          markSaving(info.event, false);
          calendar.refetchEvents();

        } catch (e) {
          markSaving(info.event, false);
          alert("Could not resize schedule: " + e.message);
          info.revert();
        }
      },

      // ✅ drag scheduled -> unallocated zone
      eventDragStop: async function(info) {
        const rect = dropZone.getBoundingClientRect();
        const x = info.jsEvent.clientX;
        const y = info.jsEvent.clientY;

        const inside = x >= rect.left && x <= rect.right && y >= rect.top && y <= rect.bottom;
        if (!inside) return;

        try {
          markSaving(info.event, true);

          await postJSON(
            `{% url 'scheduling:unschedule_jobtask' 0 %}`.replace("/0/", `/${info.event.id}/`),
            {}
          );

          info.event.remove();
          await loadUnallocated(document.getElementById("serviceTypeFilter").value.trim());

        } catch (e) {
          alert("Could not unallocate: " + e.message);
          calendar.refetchEvents();
        }
      }
    });

    calendar.render();


    wireUnallocateDropZone(dropZone, calendar);

    technicianFilter.addEventListener("change", () => {
      calendar.refetchEvents();
    });

    // Render grouped list when in list view
    calendar.on("datesSet", () => renderGroupedList(calendar));
    calendar.on("eventsSet", () => renderGroupedList(calendar));
  });
</script>

<script>
  function isListView(calendar) {
    return calendar?.view?.type?.startsWith("list");
  }

  function renderGroupedList(calendar) {
    const container = document.getElementById("listGroupedContainer");
    const fcListTable = document.querySelector(".fc-list-table");

    if (!isListView(calendar)) {
      container.style.display = "none";
      container.innerHTML = "";
      if (fcListTable) fcListTable.style.display = "";
      return;
    }

    const viewStart = calendar.view.activeStart;
    const viewEnd = calendar.view.activeEnd;

    const events = calendar.getEvents().filter(ev => {
      if (!ev.start) return false;
      return ev.start >= viewStart && ev.start < viewEnd;
    });

    // ✅ If no events for this day, show FullCalendar's default message only
    if (!events.length) {
      container.style.display = "none";
      container.innerHTML = "";
      if (fcListTable) fcListTable.style.display = "";
      return;
    }

    const groups = new Map();

    for (const ev of events) {
      const techName = String(ev.extendedProps.technician || "Unassigned").trim() || "Unassigned";
      const key = techName.toLowerCase();

      if (!groups.has(key)) {
        groups.set(key, { label: techName, items: [] });
      }
      groups.get(key).items.push(ev);
    }

    const groupArray = Array.from(groups.values())
      .sort((a, b) => a.label.localeCompare(b.label));

    container.innerHTML = "";
    for (const group of groupArray) {
      // ✅ sort each technician's items by time
      group.items.sort((a, b) => {
        const at = a.start ? a.start.getTime() : 0;
        const bt = b.start ? b.start.getTime() : 0;
        return at - bt;
      });

      const section = document.createElement("div");
      section.className = "list-grouped-section";

      const header = document.createElement("div");
      header.className = "list-grouped-header";
      header.textContent = group.label;

      section.appendChild(header);

      for (const ev of group.items) {
        const startDate = ev.start ? ev.start.toLocaleDateString() : "No date";
        const jobTaskId = ev.extendedProps.job_task_id || ev.id;

        const serviceType = ev.extendedProps.service_type || ev.extendedProps.serviceType || "Service Type";

        const item = document.createElement("div");
        item.className = "list-grouped-item";
        item.style.cursor = "pointer";
        item.setAttribute("draggable", "true");

        item.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", String(jobTaskId));
          e.dataTransfer.effectAllowed = "move";
        });

        item.addEventListener("click", () => {
          window.location.href = `/job-tasks/${jobTaskId}/`;
        });

        const start = ev.start ? ev.start.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) : "";
        const end = ev.end ? ev.end.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit" }) : "";
        const timeRange = `${start}${end ? " - " + end : ""}`;

        item.innerHTML = `
          <div class="small">
            ${serviceType} | ${startDate} | ${timeRange} | Job Task #${jobTaskId}
          </div>
        `;
        section.appendChild(item);
      }

      container.appendChild(section);
    }

    container.style.display = "";
    if (fcListTable) fcListTable.style.display = "none";
  }
</script>
{% endblock %}
