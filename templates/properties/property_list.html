{% extends "base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">Properties</h1>

  <a href="{% url 'properties:create' %}" class="btn btn-primary">
    <i class="bi bi-plus-lg me-1"></i>
    Add Property
  </a>
</div>

<!-- SEARCH BAR (¼ WIDTH + LIVE) -->
<div class="row mb-3">
  <div class="col-md-3">
    <input
      id="property-search"
      class="form-control"
      type="search"
      name="q"
      value="{{ q }}"
      placeholder="Search properties…"
      autocomplete="off"
      aria-label="Search properties"
    >
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width:140px;">Site ID</th>
          <th style="width:500px;">Property</th>
          <th style="width:650px;">Customer</th>
          <th style="width:120px;">Status</th>
          <th class="text-end" style="width:300px;">Actions</th>
        </tr>
      </thead>

      <tbody id="property-table-body">
        {% for item in items %}
        <tr
          class="property-row"
          tabindex="0"
          data-view-url="{% url 'properties:detail' item.pk %}"
          data-edit-url="{% url 'properties:update' item.pk %}"
          data-delete-url="{% url 'properties:delete' item.pk %}"
          aria-label="Property row {{ item.site_id }}"
        >
          <td class="fw-semibold">
              {{ item.site_id }}
          </td>

          <td>
            {{ item.building_name }}<br>
            <small class="text-muted">
              {{ item.street }}, {{ item.city }}
              {% if item.state %}, {{ item.state }}{% endif %}
              {% if item.post_code %} {{ item.post_code }}{% endif %}
            </small>
          </td>

          <!-- CUSTOMER -->
          <td class="text-wrap">
            {% if item.customer %}
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-person-circle text-muted"></i>

                <a
                  href="{% url 'customers:detail' item.customer.pk %}"
                  class="text-decoration-none"
                  target="_blank"
                  rel="noopener noreferrer"
                  data-bs-toggle="tooltip"
                  title="Open customer details in new tab"
                >
                  {{ item.customer.customer_name }}
                </a>

                {% if item.customer.customer_type %}
                  {% if item.customer.customer_type == "Strata" %}
                    <span class="badge text-bg-info">Strata</span>
                  {% elif item.customer.customer_type == "Government" %}
                    <span class="badge text-bg-primary">Government</span>
                  {% elif item.customer.customer_type == "Housing" %}
                    <span class="badge text-bg-warning">Housing</span>
                  {% else %}
                    <span class="badge text-bg-secondary">{{ item.customer.customer_type }}</span>
                  {% endif %}
                {% endif %}
              </div>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>

          <td>
            {% if item.active_status %}
              <span class="badge bg-success">Active</span>
            {% else %}
              <span class="badge bg-secondary">Inactive</span>
            {% endif %}
          </td>

          <!-- ACTIONS (OLD STYLE) -->
          <td class="text-end">

            <!-- MAP -->
            <a
              class="btn btn-outline-secondary btn-sm"
              href="https://www.google.com/maps/search/?api=1&query={{ item.street|urlencode }}+{{ item.city|urlencode }}+{{ item.state|urlencode }}+{{ item.post_code|urlencode }}"
              target="_blank"
              rel="noopener noreferrer"
              data-bs-toggle="tooltip"
              title="Open property in Google Maps"
              aria-label="Open property in Google Maps"
            >
              <i class="bi bi-geo-alt"></i>
            </a>

            <!-- VIEW -->
            <a
              class="btn btn-outline-primary btn-sm"
              href="{% url 'properties:detail' item.pk %}"
              data-bs-toggle="tooltip"
              title="View property details (V)"
              aria-label="View property details"
            >
              <i class="bi bi-eye"></i>
            </a>

            <!-- EDIT -->
            <a
              class="btn btn-outline-warning btn-sm"
              href="{% url 'properties:update' item.pk %}"
              data-bs-toggle="tooltip"
              title="Edit property (E)"
              aria-label="Edit property"
            >
              <i class="bi bi-pencil"></i>
            </a>

            <!-- DELETE (CONFIRM POPOVER -> UNDO TOAST) -->
            <button
              type="button"
              class="btn btn-outline-danger btn-sm delete-btn"
              data-bs-toggle="popover"
              data-delete-url="{% url 'properties:delete' item.pk %}"
              title="Confirm delete"
              aria-label="Delete property"
            >
              <i class="bi bi-trash"></i>
            </button>

          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center text-muted py-4">
            No properties found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

<!-- UNDO TOAST (floating, no layout change) -->
<div class="position-fixed bottom-0 end-0 p-3" style="z-index: 1080;">
  <div id="undoToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="toast-header">
      <i class="bi bi-exclamation-triangle me-2"></i>
      <strong class="me-auto">Delete</strong>
      <small class="text-muted">Pending</small>
      <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
    <div class="toast-body d-flex align-items-center justify-content-between gap-3">
      <span>Delete queued. Undo?</span>
      <button type="button" id="undoBtn" class="btn btn-sm btn-outline-secondary">
        Undo
      </button>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    // Bootstrap must exist now (loaded from base.html)
    if (typeof bootstrap === "undefined") {
      console.error("Bootstrap JS not loaded. Tooltips/popovers/toast cannot run.");
      return;
    }

    const searchInput = document.getElementById("property-search");
    const tableBody = document.getElementById("property-table-body");

    // Selected row for keyboard shortcuts
    let selectedRow = null;

    // Undo toast state
    let pendingDeleteTimer = null;
    let pendingDeleteUrl = null;

    const undoToastEl = document.getElementById("undoToast");
    const undoToast = new bootstrap.Toast(undoToastEl, { autohide: false });
    const undoBtn = document.getElementById("undoBtn");

    function clearPendingDelete() {
      if (pendingDeleteTimer) {
        clearTimeout(pendingDeleteTimer);
        pendingDeleteTimer = null;
      }
      pendingDeleteUrl = null;
    }

    function queueDelete(url) {
      clearPendingDelete();
      pendingDeleteUrl = url;

      undoToast.show();

      pendingDeleteTimer = setTimeout(() => {
        undoToast.hide();
        window.location.href = pendingDeleteUrl;
      }, 4000);
    }

    undoBtn.addEventListener("click", () => {
      clearPendingDelete();
      undoToast.hide();
    });

    function initTooltips() {
      document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(el => {
        const inst = bootstrap.Tooltip.getInstance(el);
        if (inst) inst.dispose();

        new bootstrap.Tooltip(el, {
          trigger: "hover focus",        // keyboard + mobile long-press friendly
          delay: { show: 250, hide: 100 }
        });
      });
    }

    function hideAllDeletePopovers() {
      document.querySelectorAll("button.delete-btn").forEach(btn => {
        const inst = bootstrap.Popover.getInstance(btn);
        if (inst) inst.hide();
      });
    }

    function initDeletePopovers() {
      document.querySelectorAll("button.delete-btn").forEach(btn => {
        const inst = bootstrap.Popover.getInstance(btn);
        if (inst) inst.dispose();

        const url = btn.getAttribute("data-delete-url");

        new bootstrap.Popover(btn, {
          trigger: "click",
          container: "body",   // avoids clipping inside table/card
          html: true,
          sanitize: true,
          content: `
            <div class="d-flex gap-2">
              <button type="button" class="btn btn-sm btn-outline-secondary js-popover-cancel">
                Cancel
              </button>
              <a href="${url}" class="btn btn-sm btn-danger js-delete-confirm">
                Yes, delete
              </a>
            </div>
          `
        });
      });
    }

    function initRowSelection() {
      document.querySelectorAll("tr.property-row").forEach(row => {
        row.addEventListener("click", (e) => {
          if (e.target.closest("a, button")) return;
          selectRow(row);
        });
        row.addEventListener("focus", () => selectRow(row));
      });
    }

    function selectRow(row) {
      if (selectedRow && selectedRow !== row) selectedRow.classList.remove("table-active");
      selectedRow = row;
      selectedRow.classList.add("table-active");
    }

    // Popover Cancel / Confirm (delegated)
    document.addEventListener("click", (e) => {
      const cancelBtn = e.target.closest(".js-popover-cancel");
      if (cancelBtn) {
        e.preventDefault();
        hideAllDeletePopovers();
        return;
      }

      const confirmLink = e.target.closest(".js-delete-confirm");
      if (confirmLink) {
        e.preventDefault();
        hideAllDeletePopovers();
        queueDelete(confirmLink.getAttribute("href"));
        return;
      }

      // Click outside closes popovers
      if (!e.target.closest(".popover") && !e.target.closest("button.delete-btn")) {
        hideAllDeletePopovers();
      }
    });

    // Keyboard shortcuts: V=view, E=edit, Delete=delete (selected row)
    document.addEventListener("keydown", (e) => {
      const tag = (e.target && e.target.tagName) ? e.target.tagName.toLowerCase() : "";
      if (tag === "input" || tag === "textarea" || e.target.isContentEditable) return;
      if (!selectedRow) return;

      const viewUrl = selectedRow.getAttribute("data-view-url");
      const editUrl = selectedRow.getAttribute("data-edit-url");
      const deleteUrl = selectedRow.getAttribute("data-delete-url");

      if (e.key === "v" || e.key === "V") {
        e.preventDefault();
        window.location.href = viewUrl;
      } else if (e.key === "e" || e.key === "E") {
        e.preventDefault();
        window.location.href = editUrl;
      } else if (e.key === "Delete") {
        e.preventDefault();
        queueDelete(deleteUrl);
      }
    });

    function initAllUI() {
      initTooltips();
      initDeletePopovers();
      initRowSelection();
    }

    // Live search
    let debounceTimer = null;
    searchInput.addEventListener("input", function () {
      clearTimeout(debounceTimer);

      debounceTimer = setTimeout(() => {
        fetch(`{% url 'properties:list' %}?q=${encodeURIComponent(searchInput.value)}`, {
          headers: { "X-Requested-With": "XMLHttpRequest" }
        })
          .then(r => r.text())
          .then(html => {
            const doc = new DOMParser().parseFromString(html, "text/html");
            const newBody = doc.querySelector("#property-table-body");
            if (newBody) {
              tableBody.innerHTML = newBody.innerHTML;
              selectedRow = null;
              initAllUI();
            }
          });
      }, 250);
    });

    initAllUI();
  });
</script>

{% endblock %}
