{% extends "base.html" %}

{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">Properties</h1>

  <a href="{% url 'properties:create' %}" class="btn btn-primary">
    <i class="bi bi-plus-lg me-1"></i>
    Add Property
  </a>
</div>

<!-- SEARCH + FILTERS -->
<div class="row mb-3 g-2 align-items-end">
  <div class="col-md-3">
    <input
      id="property-search"
      class="form-control"
      type="search"
      name="q"
      value="{{ q }}"
      placeholder="Search properties…"
      autocomplete="off"
      aria-label="Search properties"
    >
  </div>

  <div class="col-md-9">
    <div class="d-flex flex-wrap gap-2">
      {# Build filter links that preserve q #}
      <a class="btn btn-sm {% if not validated %}btn-primary{% else %}btn-outline-primary{% endif %}"
         href="{% url 'properties:list' %}{% if q %}?q={{ q|urlencode }}{% endif %}">
        All
      </a>

      <a class="btn btn-sm {% if validated == '1' %}btn-primary{% else %}btn-outline-primary{% endif %}"
         href="{% url 'properties:list' %}?validated=1{% if q %}&q={{ q|urlencode }}{% endif %}">
        Validated
      </a>

      <a class="btn btn-sm {% if validated == '0' %}btn-primary{% else %}btn-outline-primary{% endif %}"
         href="{% url 'properties:list' %}?validated=0{% if q %}&q={{ q|urlencode }}{% endif %}">
        Unvalidated
      </a>
    </div>
  </div>
</div>

<div class="card shadow-sm">
  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width:140px;">Site ID</th>
          <th style="width:800px;">Property</th>
          <th style="width:550px;">Customer</th>
          <th style="width:140px;">Status</th>
          <th class="text-end" style="width:300px;">Actions</th>
        </tr>
      </thead>

      <tbody id="property-table-body">
        {% for item in items %}
        <tr
          class="property-row"
          tabindex="0"
          data-view-url="{% url 'properties:detail' item.pk %}"
          data-edit-url="{% url 'properties:update' item.pk %}"
          data-delete-url="{% url 'properties:delete' item.pk %}"
          aria-label="Property row {{ item.site_id }}"
        >
          <!-- SITE ID -->
          <td class="fw-semibold">
            <a
              href="{% url 'properties:detail' item.pk %}"
              class="text-decoration-none"
              aria-label="View property {{ item.site_id }}"
            >
              {{ item.site_id }}
            </a>
          </td>

          <!-- PROPERTY -->
          <td>
            <div class="fw-medium fs-6 lh-sm">
              {{ item.street }}, {{ item.city }}
              {% if item.state %}, {{ item.state }}{% endif %}
              {% if item.post_code %} {{ item.post_code }}{% endif %}
            </div>

            <div class="d-flex align-items-center gap-1 flex-wrap mt-1">
              {% if item.property_description %}
                <span class="badge text-bg-info">
                  {{ item.get_property_description_display }}
                </span>
              {% endif %}

              {% if item.strata_plan %}
                <span
                  class="badge text-bg-secondary"
                  data-bs-toggle="tooltip"
                  title="Strata Plan"
                >
                  Strata Plan: {{ item.strata_plan }}
                </span>
              {% endif %}
            </div>

            <div class="small text-muted mt-1 d-flex flex-wrap gap-3">
              {% if item.number_of_residential %}
                <span>
                  <i class="bi bi-house-door me-1"></i>{{ item.number_of_residential }}
                </span>
              {% endif %}

              {% if item.number_of_commercial %}
                <span>
                  <i class="bi bi-building me-1"></i>{{ item.number_of_commercial }}
                </span>
              {% endif %}

              {% if item.afss_due_date %}
                <span>
                  <i class="bi bi-calendar-event me-1"></i>
                  Due: {{ item.afss_due_date|date:"d-M-y" }}
                </span>
              {% endif %}

              {% if item.certification_date %}
                <span>
                  <i class="bi bi-patch-check me-1"></i>
                  Cert: {{ item.certification_date|date:"d-M-y" }}
                </span>
              {% endif %}
            </div>
          </td>

          <!-- CUSTOMER -->
          <td class="text-wrap">
            {% if item.customer %}
              <div class="d-flex align-items-center gap-2">
                <i class="bi bi-person-circle text-muted"></i>

                <a
                  href="{% url 'customers:detail' item.customer.pk %}"
                  class="text-decoration-none"
                  target="_blank"
                  rel="noopener noreferrer"
                >
                  {{ item.customer.customer_name }}
                </a>

                {% if item.customer.customer_type %}
                  <span class="badge text-bg-secondary">
                    {{ item.customer.customer_type }}
                  </span>
                {% endif %}
              </div>
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </td>

          <!-- STATUS -->
          <td>
            <div class="d-flex flex-column gap-1">
              {% if item.active_status %}
                <span class="badge bg-success">Active</span>
              {% else %}
                <span class="badge bg-secondary">Inactive</span>
              {% endif %}

              {% if item.coords_validated %}
                <span class="badge bg-primary">Validated ✓</span>
              {% else %}
                <span class="badge bg-warning text-dark">Not validated</span>
              {% endif %}
            </div>
          </td>

          <!-- ACTIONS -->
          <td class="text-end">
            <a
              href="{% url 'properties:detail' item.pk %}"
              class="btn btn-sm btn-outline-primary"
            >
              View
            </a>

            <a
              href="{% url 'properties:update' item.pk %}"
              class="btn btn-sm btn-outline-secondary"
            >
              Edit
            </a>

            <a
              href="{% url 'properties:delete' item.pk %}"
              class="btn btn-sm btn-outline-danger"
            >
              Delete
            </a>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center text-muted py-4">
            No properties found.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
