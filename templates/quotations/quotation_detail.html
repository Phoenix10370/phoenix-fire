{% extends "base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">Quotation {{ item.number }}</h1>

  <div class="d-flex gap-2">
    <a href="{% url 'quotations:update' item.pk %}" class="btn btn-outline-secondary">
      Edit
    </a>

    <a href="{% url 'quotations:print_pdf' item.pk %}"
       class="btn btn-primary"
       target="_blank">
      <i class="bi bi-filetype-pdf me-1"></i>
      Print PDF
    </a>

    <a href="{% url 'quotations:send_email' item.pk %}" class="btn btn-success">
      <i class="bi bi-envelope me-1"></i>
      Email PDF
    </a>

    <button type="button" class="btn btn-outline-primary" onclick="window.print()">
      <i class="bi bi-printer me-1"></i>
      Print Page
    </button>

    <a href="{% url 'quotations:delete' item.pk %}" class="btn btn-outline-danger">
      Delete
    </a>
  </div>
</div>

<!-- PROPERTY CONTEXT -->
<div class="card mb-3 shadow-sm">
  <div class="card-body">
    <div class="row g-0">
      <!-- LEFT: PROPERTY -->
      <div class="col-12 col-md-7 pe-md-4">
        <h6 class="text-muted mb-1">Property</h6>

        <div class="fw-semibold">{{ item.site.building_name }}</div>

        <div class="text-muted small">
          {{ item.site.site_id }} — {{ item.site.street }}, {{ item.site.city }}, {{ item.site.state }} {{ item.site.post_code }}
        </div>
      </div>

      <!-- DIVIDER -->
      <div class="col-12 d-md-none my-3">
        <hr class="my-0">
      </div>

      <div class="d-none d-md-block col-md-1 position-relative">
        <div class="h-100 position-absolute top-0 start-50 translate-middle-x border-start"></div>
      </div>

      <!-- RIGHT: CUSTOMER / EMAIL -->
      <div class="col-12 col-md-4 ps-md-4">
        {% if item.site.customer %}
          <div class="mb-2">
            <div class="text-muted small">Customer</div>
            <div class="fw-semibold">{{ item.site.customer.customer_name }}</div>
          </div>
        {% endif %}

        {% if item.site.fire_coordinator_email %}
          <div>
            <div class="text-muted small">Fire Coordinator Email</div>
            <div class="fw-semibold">
              <a href="mailto:{{ item.site.fire_coordinator_email }}">
                {{ item.site.fire_coordinator_email }}
              </a>
            </div>
          </div>
        {% endif %}

        {% if not item.site.customer and not item.site.fire_coordinator_email %}
          <span class="text-muted">—</span>
        {% endif %}
      </div>
    </div>
  </div>
</div>

<!-- ACCEPT / DECLINE -->
<div class="card mb-3 shadow-sm">
  <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
    <span>Approval</span>

    {% if item.status == "accepted" %}
      <span class="badge bg-success">Accepted</span>
    {% elif item.status == "rejected" %}
      <span class="badge bg-danger">Declined</span>
    {% elif item.status == "sent" %}
      <span class="badge bg-primary">Sent</span>
    {% elif item.status == "created" %}
      <span class="badge bg-secondary">Created</span>
    {% elif item.status == "draft" %}
      <span class="badge bg-secondary">Draft</span>
    {% else %}
      <span class="badge bg-secondary">{{ item.get_status_display }}</span>
    {% endif %}
  </div>

  <div class="card-body">
  {% if item.status != "accepted" and item.status != "rejected" %}
    <div class="row g-2">
      <!-- ACCEPT -->
      <div class="col-12 col-md-6 d-grid">
        <a href="{% url 'quotations:accept' item.pk %}"
           class="btn btn-success w-100">
          <i class="bi bi-check2-circle me-1"></i>
          Accept
        </a>
      </div>

      <!-- DECLINE -->
      <div class="col-12 col-md-6">
        <form method="post"
              action="{% url 'quotations:reject' item.pk %}"
              class="d-grid">
          {% csrf_token %}
          <button type="submit"
                  class="btn btn-outline-danger w-100">
            <i class="bi bi-x-circle me-1"></i>
            Decline
          </button>
        </form>
      </div>
    </div>

    <div class="text-muted small mt-3">
      Accepting or declining will lock the quotation status.
    </div>
  {% endif %}
</div>


    {% if item.status == "accepted" %}
      <div class="row g-3 px-2 px-md-3">
        <div class="col-md-4">
          <div class="text-muted small">Accepted By</div>
          <div class="fw-semibold">
            {% if item.accepted_by_name %}
              {{ item.accepted_by_name }}
            {% elif item.accepted_by %}
              {{ item.accepted_by }}
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>

        <div class="col-md-4">
          <div class="text-muted small">Accepted Date</div>
          <div class="fw-semibold">
            {% if item.accepted_date %}
              {{ item.accepted_date|date:"d M Y" }}
            {% elif item.accepted_at %}
              {{ item.accepted_at|date:"d M Y" }}
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>

        <div class="col-md-4">
          <div class="text-muted small">Work Order Number</div>
          <div class="fw-semibold">
            {% if item.work_order_number %}
              {{ item.work_order_number }}
            {% else %}
              <span class="text-muted">—</span>
            {% endif %}
          </div>
        </div>
      </div>
    {% endif %}
  </div>
</div>

{# ========================= #}
{# SERVICE ROUTINES (COLLAPSIBLE) #}
{# ========================= #}

{% if item.status == "accepted" %}
<div class="accordion mb-3 shadow-sm" id="serviceRoutinesAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="serviceRoutinesHeading">
      <button
        class="accordion-button collapsed fw-semibold"
        type="button"
        data-bs-toggle="collapse"
        data-bs-target="#serviceRoutinesCollapse"
        aria-expanded="false"
        aria-controls="serviceRoutinesCollapse"
      >
        Service Routines
        <span class="ms-2 text-muted small">
          ({{ item.service_routines.count }})
        </span>
      </button>
    </h2>

    <div
      id="serviceRoutinesCollapse"
      class="accordion-collapse collapse"
      aria-labelledby="serviceRoutinesHeading"
      data-bs-parent="#serviceRoutinesAccordion"
    >
      <div class="accordion-body p-0">

        {% if item.service_routines.exists %}
          <div class="list-group list-group-flush">
            {% for r in item.service_routines.all %}
              <a
                href="{% url 'routines:detail' r.pk %}"
                class="list-group-item list-group-item-action d-flex justify-content-between align-items-center"
              >
                <div>
                  <div class="fw-semibold">{{ r.name }}</div>
                  <div class="text-muted small">
                    Month Due: {{ r.get_month_due_display }}
                  </div>
                </div>
                <span class="badge bg-secondary">{{ r.items.count }} items</span>
              </a>
            {% endfor %}
          </div>
        {% else %}
          <div class="p-3">
            <a href="{% url 'routines:create_from_quotation' item.pk %}"
               class="btn btn-primary">
              Create Service Routines
            </a>

            <div class="text-muted small mt-2">
              You will be asked to select the Annual Due Month.
            </div>
          </div>
        {% endif %}

      </div>
    </div>
  </div>
</div>
{% endif %}

{# ========================= #}
{# COMMENTS / CORRESPONDENCE (COLLAPSIBLE) #}
{# ========================= #}

<div class="accordion mb-3 shadow-sm" id="quoteCommentsAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="quoteCommentsHeading">
      <button class="accordion-button collapsed fw-semibold" type="button"
              data-bs-toggle="collapse" data-bs-target="#quoteCommentsCollapse"
              aria-expanded="false" aria-controls="quoteCommentsCollapse">
        Comments / Correspondence
        <span class="ms-2 text-muted small">
          ({{ item.comments.count }}, {{ item.correspondence.count }})
        </span>
      </button>
    </h2>

    <div id="quoteCommentsCollapse" class="accordion-collapse collapse"
         aria-labelledby="quoteCommentsHeading" data-bs-parent="#quoteCommentsAccordion">
      <div class="accordion-body">

        <div class="row g-3">
          <!-- COMMENTS -->
          <div class="col-12 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
                <span>Comments</span>
              </div>

              <div class="card-body">
                <form method="post" action="{% url 'quotations:add_comment' item.pk %}">
                  {% csrf_token %}

                  <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-primary btn-sm" type="submit">
                      Add Comment
                    </button>
                  </div>

                  <div class="mb-3">
                    <label class="form-label fw-semibold">Comment</label>
                    <textarea name="comment" rows="3" class="form-control" placeholder="Type your comment..."></textarea>
                    <div class="text-muted small mt-1">
                      Date and Created by are saved automatically.
                    </div>
                  </div>
                </form>

                <hr class="my-3">

                {% if comments %}
                  <div class="list-group">
                    {% for c in comments %}
                      <div class="list-group-item">
                        <div class="d-flex justify-content-between align-items-start">
                          <div class="fw-semibold">
                            {% if c.created_by %}
                              {{ c.created_by }}
                            {% else %}
                              <span class="text-muted">System</span>
                            {% endif %}
                          </div>
                          <div class="text-muted small">
                            {{ c.created_at|date:"d M Y, h:i A" }}
                          </div>
                        </div>
                        <div class="mt-2">
                          {{ c.comment|linebreaksbr }}
                        </div>
                      </div>
                    {% endfor %}
                  </div>
                {% else %}
                  <div class="text-muted">No comments yet.</div>
                {% endif %}
              </div>
            </div>
          </div>

          <!-- CORRESPONDENCE -->
          <div class="col-12 col-md-6">
            <div class="card shadow-sm h-100">
              <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
                <span>Correspondence</span>
              </div>

              <div class="card-body">
                <form method="post"
                      action="{% url 'quotations:upload_correspondence' item.pk %}"
                      enctype="multipart/form-data">
                  {% csrf_token %}

                  <div class="d-flex justify-content-end mb-2">
                    <button class="btn btn-primary btn-sm" type="submit">
                      Insert
                    </button>
                  </div>

                  <div class="mb-3">
                    <label class="form-label fw-semibold">Document</label>
                    <input type="file" name="document" class="form-control">
                    <div class="text-muted small mt-1">
                      Date is saved automatically on upload.
                    </div>
                  </div>
                </form>

                <hr class="my-3">

                {% if correspondence %}
                  <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th style="width: 170px;">Date</th>
                          <th>Document Name</th>
                          <th class="text-end" style="width: 120px;">Export</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for d in correspondence %}
                          <tr>
                            <td class="text-muted">
                              {{ d.created_at|date:"d M Y, h:i A" }}
                            </td>
                            <td class="fw-semibold">
                              {{ d.original_name|default:"Document" }}
                            </td>
                            <td class="text-end">
                              <a class="btn btn-outline-secondary btn-sm"
                                 href="{% url 'quotations:download_correspondence' item.pk d.pk %}">
                                Export
                              </a>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="text-muted">No correspondence uploaded yet.</div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ✅ HISTORY LOG (Collapsible) -->
<div class="accordion mb-3 shadow-sm" id="quoteLogAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="quoteLogHeading">
      <button class="accordion-button collapsed fw-semibold" type="button"
              data-bs-toggle="collapse" data-bs-target="#quoteLogCollapse"
              aria-expanded="false" aria-controls="quoteLogCollapse">
        History Log
        <span class="ms-2 text-muted small">
          {% if item.logs.all %}({{ item.logs.count }}){% endif %}
        </span>
      </button>
    </h2>

    <div id="quoteLogCollapse" class="accordion-collapse collapse"
         aria-labelledby="quoteLogHeading" data-bs-parent="#quoteLogAccordion">
      <div class="accordion-body p-0">

        <div class="table-responsive">
          <table class="table table-sm table-hover mb-0 align-middle">
            <thead class="table-light">
              <tr>
                <th style="width: 190px;">Date / Time</th>
                <th style="width: 160px;">User</th>
                <th style="width: 140px;">Action</th>
                <th>Details</th>
              </tr>
            </thead>

            <tbody>
              {% for log in item.logs.all %}
                <tr>
                  <td class="text-muted">
                    {{ log.created_at|date:"d M Y, h:i A" }}
                  </td>

                  <td>
                    {% if log.actor %}
                      {{ log.actor }}
                    {% else %}
                      <span class="text-muted">System</span>
                    {% endif %}
                  </td>

                  <td>
                    <span class="badge bg-secondary">{{ log.get_action_display }}</span>
                  </td>

                  <td>
                    {% if log.message %}
                      {{ log.message }}
                    {% else %}
                      <span class="text-muted">—</span>
                    {% endif %}
                  </td>
                </tr>
              {% empty %}
                <tr>
                  <td colspan="4" class="text-center text-muted py-3">
                    No history yet.
                  </td>
                </tr>
              {% endfor %}
            </tbody>

          </table>
        </div>

      </div>
    </div>
  </div>
</div>

<!-- QUOTATION DETAILS -->
<div class="card mb-4 shadow-sm">
  <div class="card-header bg-light fw-semibold">
    Quotation Details
  </div>

  <div class="card-body">
    <div class="row g-3">
      <div class="col-md-4">
        <div class="text-muted small">Status</div>
        <div class="fw-semibold">{{ item.get_status_display }}</div>
      </div>

      <div class="col-md-4">
        <div class="text-muted small">Created</div>
        <div class="fw-semibold">{{ item.created_at|date:"d M Y" }}</div>
      </div>

      <div class="col-md-12">
        <div class="text-muted small">Notes</div>
        <div>
          {% if item.notes %}
            {{ item.notes|linebreaksbr }}
          {% else %}
            <span class="text-muted">—</span>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- EFSM LINE ITEMS -->
<div class="card shadow-sm mb-4">
  <div class="card-header bg-light fw-semibold">
    EFSM Line Items
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width: 140px;">EFSM Code</th>
          <th>Description</th>
          <th class="text-end" style="width: 120px;">Qty</th>
          <th class="text-end" style="width: 160px;">Unit Price</th>
          <th class="text-end" style="width: 160px;">Line Total</th>
        </tr>
      </thead>

      <tbody>
        {% for li in item.items.all %}
          <tr>
            <td class="fw-semibold">{{ li.efsm_code.code }}</td>
            <td>{{ li.efsm_code.fire_safety_measure }}</td>
            <td class="text-end">{{ li.quantity }}</td>
            <td class="text-end">${{ li.unit_price|floatformat:2 }}</td>
            <td class="text-end">${{ li.line_total|floatformat:2 }}</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="5" class="text-center text-muted py-3">
              No EFSM line items.
            </td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card-footer bg-white">
    <div class="row justify-content-end">
      <div class="col-12 col-md-5 col-lg-4">
        <div class="d-flex justify-content-between py-1">
          <span class="text-muted">Subtotal</span>
          <strong>${{ subtotal|floatformat:2 }}</strong>
        </div>

        <div class="d-flex justify-content-between py-1">
          <span class="text-muted">GST (10%)</span>
          <strong>${{ gst|floatformat:2 }}</strong>
        </div>

        <hr class="my-2">

        <div class="d-flex justify-content-between py-1">
          <span class="text-muted">Total</span>
          <strong>${{ total|floatformat:2 }}</strong>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="d-flex justify-content-end gap-2">
  <a href="{% url 'quotations:list' %}" class="btn btn-outline-secondary">
    Back to Quotations
  </a>
</div>
{% endblock %}
