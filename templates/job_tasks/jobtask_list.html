{% extends "base.html" %}
{% block content %}

<style>
  .table-responsive-dropdown {
    overflow: visible;
  }

  @media (max-width: 575.98px) {
    .table-responsive-dropdown {
      overflow-x: auto;
    }
  }
</style>

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h3 mb-1">Job Tasks</h1>
    <div class="text-muted">Create and manage tasks linked to a Property and Customer.</div>
  </div>
  <div class="d-flex gap-2">
    <a href="{% url 'job_tasks:create' %}" class="btn btn-primary">+ New Job Task</a>
  </div>
</div>

<form method="get" class="row g-2 mb-3">
  <div class="col-md-6">
    <input type="text" name="q" value="{{ q }}" class="form-control"
           placeholder="Search title, description, address...">
  </div>
  <div class="col-md-6 d-flex gap-2">
    <button class="btn btn-outline-primary" type="submit">Search</button>
    <a class="btn btn-outline-secondary" href="{% url 'job_tasks:list' %}">Clear</a>
  </div>
</form>

<div class="card shadow-sm">

  <!-- BULK HEADER -->
  <div class="card-header bg-white">
    <div class="d-flex flex-wrap gap-2 align-items-center">
      <div class="d-flex align-items-center gap-2">
        <div class="form-check mb-0">
          <input class="form-check-input" type="checkbox" id="selectAll">
          <label class="form-check-label" for="selectAll">
            Select All (this page)
          </label>
        </div>

        <div class="dropdown">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" type="button"
                  data-bs-toggle="dropdown">
            Selection
          </button>
          <ul class="dropdown-menu">
            <li><button class="dropdown-item" type="button" id="selectAllBtn">Select all on page</button></li>
            <li><button class="dropdown-item" type="button" id="clearAllBtn">Clear selection</button></li>
          </ul>
        </div>

        <span class="text-muted small" id="selectedCountText">0 selected</span>
      </div>

      <div class="ms-auto dropdown">
        <button class="btn btn-sm btn-primary dropdown-toggle" type="button"
                data-bs-toggle="dropdown">
          Bulk Actions
        </button>
        <ul class="dropdown-menu dropdown-menu-end">
          <li>
            <button class="dropdown-item" type="button">Bulk Email checked Job Tasks</button>
          </li>
          <li><hr class="dropdown-divider"></li>
          <li>
            <button class="dropdown-item text-danger" type="button" data-action="delete">
              Bulk Delete checked Job Tasks
            </button>
          </li>
        </ul>
      </div>
    </div>
  </div>

  <!-- TABLE -->
  <form id="bulkForm" method="post" action="{% url 'job_tasks:bulk_action' %}"
        data-skip-unsaved-warning="1">
    {% csrf_token %}
    <input type="hidden" name="action" id="bulkActionInput" value="">

    <div class="table-responsive-dropdown">
      <table class="table table-sm table-hover align-middle mb-0">
        <thead class="table-light">
          <tr>
            <th class="text-center" style="width:48px;">#</th>
            <th style="width:200px;">Job Task</th>
            <th style="width:200px;">Service Type</th>
            <th style="width:260px;">Service</th>
            <th>Property</th>
            <th class="text-end" style="width:240px;">Actions</th>
          </tr>
        </thead>

        <tbody>
          {% for t in job_tasks %}
            <tr>
              <td class="text-center">
                <input class="form-check-input jobtask-checkbox"
                       type="checkbox"
                       name="job_task_ids"
                       value="{{ t.pk }}">
              </td>

              <!-- Job Task # + Status -->
              <td>
                <div class="fw-semibold">
                  <a href="{% url 'job_tasks:detail' t.pk %}" class="text-decoration-none">
                    Job Task #{{ t.pk }}
                  </a>
                </div>
                <div class="text-muted small">
                  {{ t.get_status_display }}
                </div>
              </td>

              <!-- Service Type -->
              <td>
                <div>
                  {% if t.service_type %}
                    {{ t.service_type.name }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </div>
                <div class="text-muted small">
                  {% if t.parent_job_id %}
                    Child Job
                  {% elif t.child_jobs.all %}
                    Parent Job
                  {% endif %}
                </div>
              </td>

              <!-- Service Date → Service Time → Technician -->
              <td>
                <div>
                  {% if t.service_date %}
                    {{ t.service_date }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </div>

                <div class="text-muted small">
                  {% if t.service_time %}
                    {{ t.service_time }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </div>

                <div class="text-muted small">
                  {% if t.service_technician %}
                    {{ t.service_technician }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </div>
              </td>

              <!-- Property + Customer -->
              <td>
                <div class="fw-semibold small">
                  {% if t.site and t.site.full_address %}
                   {{ t.site.full_address }}
                  {% else %}
                    <span class="text-muted">—</span>
                  {% endif %}
                </div>
              </td>


              <td class="text-end">
                <div class="dropdown d-inline-block">
                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle"
                          type="button"
                          data-bs-toggle="dropdown"
                          aria-expanded="false">
                    Actions
                  </button>
                  <ul class="dropdown-menu dropdown-menu-end">
                    <li>
                      <button class="dropdown-item" type="button">Email</button>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <a class="dropdown-item" href="{% url 'job_tasks:detail' t.pk %}">View</a>
                    </li>
                    <li>
                      <a class="dropdown-item" href="{% url 'job_tasks:edit' t.pk %}">Edit</a>
                    </li>
                    <li><hr class="dropdown-divider"></li>
                    <li>
                      <a class="dropdown-item text-danger" href="{% url 'job_tasks:delete' t.pk %}">Delete</a>
                    </li>
                  </ul>
                </div>
              </td>
            </tr>
          {% empty %}
            <tr>
              <td colspan="6" class="p-3 text-muted">
                No job tasks found.
              </td>
            </tr>
          {% endfor %}
        </tbody>

      </table>
    </div>
  </form>
</div>

<!-- BULK JS -->
<script>
  (function () {
    const selectAll = document.getElementById("selectAll");
    const boxes = () => Array.from(document.querySelectorAll(".jobtask-checkbox"));
    const selectedCountText = document.getElementById("selectedCountText");
    const bulkForm = document.getElementById("bulkForm");
    const bulkActionInput = document.getElementById("bulkActionInput");

    const update = () => {
      const checked = boxes().filter(b => b.checked).length;
      selectedCountText.textContent = `${checked} selected`;

      if (!boxes().length) return;
      selectAll.indeterminate = checked > 0 && checked < boxes().length;
      selectAll.checked = checked === boxes().length;
    };

    selectAll.addEventListener("change", () => {
      boxes().forEach(b => b.checked = selectAll.checked);
      update();
    });

    document.getElementById("selectAllBtn").addEventListener("click", () => {
      boxes().forEach(b => b.checked = true);
      update();
    });

    document.getElementById("clearAllBtn").addEventListener("click", () => {
      boxes().forEach(b => b.checked = false);
      update();
    });

    document.addEventListener("change", e => {
      if (e.target.classList.contains("jobtask-checkbox")) update();
    });

    document.querySelectorAll("[data-action]").forEach(btn => {
      btn.addEventListener("click", () => {
        const ids = boxes().filter(b => b.checked);
        if (!ids.length) {
          alert("Please select at least one job task.");
          return;
        }

        if (!confirm(`Delete ${ids.length} selected job task(s)?`)) return;
        bulkActionInput.value = "delete";
        bulkForm.submit();
      });
    });

    update();
  })();
</script>

{% endblock %}
