{% extends "base.html" %}

{% block content %}
<script src="https://unpkg.com/htmx.org@1.9.12"></script>

<div class="d-flex justify-content-between align-items-center mb-3">
  <h1 class="h3 mb-0">Create Service Routines</h1>

  <a href="{% url 'quotations:detail' quotation.pk %}" class="btn btn-outline-secondary">
    Back to Quotation
  </a>
</div>

{% if routines_exist %}
  <div class="alert alert-warning">
    <div class="fw-semibold mb-1">Service routines already exist for this quotation.</div>
    <div class="small text-muted mb-2">
      Delete existing routines first if you want to re-test creation.
    </div>

    <form method="post"
          action="{% url 'routines:delete_routines_for_quotation' quotation.pk %}"
          onsubmit="return confirm('Delete ALL existing service routines? This cannot be undone.');">
      {% csrf_token %}
      <button type="submit" class="btn btn-danger">
        Delete Existing Service Routines
      </button>
    </form>
  </div>
{% endif %}

<div id="routine-preview">
  {% include "routines/_create_from_quotation_preview.html" with preview=preview routines_exist=routines_exist form=form %}
</div>

<div class="card shadow-sm">
  <div class="card-header bg-light fw-semibold">
    Create Service Routines
  </div>

  <div class="card-body">
    <p class="text-muted mb-3">
      Choose the <strong>Annual Due Month</strong> and an <strong>Invoice Frequency</strong>.
    </p>

    <form id="create-routines-form"
          method="post"
          action="{% url 'routines:create_from_quotation' quotation.pk %}">
      {% csrf_token %}

      <div class="mb-3">
        {{ form.annual_due_month.label_tag }}
        <div
          hx-get="{% url 'routines:create_from_quotation_preview' quotation.pk %}"
          hx-trigger="change"
          hx-include="#create-routines-form"
          hx-target="#routine-preview"
          hx-swap="innerHTML">
          {{ form.annual_due_month }}
        </div>
        {% if form.annual_due_month.errors %}
          <div class="text-danger small mt-1">{{ form.annual_due_month.errors }}</div>
        {% endif %}
      </div>

      <div class="mb-3">
        {{ form.invoice_frequency.label_tag }}
        <div
          hx-get="{% url 'routines:create_from_quotation_preview' quotation.pk %}"
          hx-trigger="change"
          hx-include="#create-routines-form"
          hx-target="#routine-preview"
          hx-swap="innerHTML">
          {{ form.invoice_frequency }}
        </div>

        <div class="form-text">
          Controls how the quotation total is distributed across the created routines.
        </div>

        {% if form.invoice_frequency.errors %}
          <div class="text-danger small mt-1">{{ form.invoice_frequency.errors }}</div>
        {% endif %}
      </div>

      <div class="d-flex flex-wrap gap-2">
        <button type="submit" class="btn btn-primary" {% if routines_exist %}disabled{% endif %}>
          Create Service Routines
        </button>

        <a href="{% url 'quotations:detail' quotation.pk %}" class="btn btn-outline-secondary">
          Cancel
        </a>
      </div>

      {% if routines_exist %}
        <div class="form-text mt-2">
          Create is disabled while routines exist. Delete them above to re-test.
        </div>
      {% endif %}
    </form>
  </div>
</div>
{% endblock %}
