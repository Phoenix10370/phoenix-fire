{# templates/routines/detail.html #}
{% extends "base.html" %}

{% block content %}

{% if prev_routine or next_routine %}
<div class="d-flex justify-content-end mb-3">
  <div class="d-inline-flex align-items-center gap-2 px-3 py-2 border rounded bg-light">

    {# FIRST #}
    {% if first_routine and current_index|default:1 > 1 %}
      <a href="{% url 'routines:detail' first_routine.pk %}"
         class="btn btn-sm btn-outline-secondary">¬´ First</a>
    {% else %}
      <button class="btn btn-sm btn-outline-secondary" disabled>¬´ First</button>
    {% endif %}

    {# PREV #}
    {% if prev_routine %}
      <a href="{% url 'routines:detail' prev_routine.pk %}"
         class="btn btn-sm btn-outline-primary">‚Üê</a>
    {% else %}
      <button class="btn btn-sm btn-outline-secondary" disabled>‚Üê</button>
    {% endif %}

    <span class="fw-bold small text-uppercase">
      PAGE {{ current_index }} OF {{ total_count }}
    </span>

    {# NEXT #}
    {% if next_routine %}
      <a href="{% url 'routines:detail' next_routine.pk %}"
         class="btn btn-sm btn-outline-primary">‚Üí</a>
    {% else %}
      <button class="btn btn-sm btn-outline-secondary" disabled>‚Üí</button>
    {% endif %}

    {# LAST #}
    {% if last_routine and total_count|default:1 > current_index %}
      <a href="{% url 'routines:detail' last_routine.pk %}"
         class="btn btn-sm btn-outline-secondary">Last ¬ª</a>
    {% else %}
      <button class="btn btn-sm btn-outline-secondary" disabled>Last ¬ª</button>
    {% endif %}

  </div>
</div>
{% endif %}

<div class="mb-3">
  <div class="d-flex gap-2 flex-wrap">

  
    <a href="{% url 'quotations:detail' routine.quotation.pk %}" class="btn btn-outline-secondary">
      Back to Quotation
    </a>

    <form method="post"
          action="{% url 'routines:create_job_task' routine.pk %}"
          class="d-inline">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-primary">
        Create Job Tasks
      </button>
    </form>

  </div>
</div>

<div class="card mb-4 shadow-sm">
  <div class="card-header bg-light d-flex justify-content-between align-items-center">
    <span class="fs-5 fw-bold">Routine Details</span>

    <span class="fs-5 fw-bold text-primary">
      Service Month ‚Äì {{ routine.get_month_due_display }}
    </span>

    <span class="fs-5 fw-bold text-primary">
      Service Type - {{ routine.get_routine_type_display }}
    </span>
  </div>

  <div class="card-body">
    <div class="row g-3 align-items-start">

      {# LEFT COLUMN #}
      <div class="col-md-8">

        <div class="mb-2">
          <div class="text-muted small">Property</div>
          <div class="fw-semibold">{{ routine.site.building_name }}</div>
          <div class="text-muted small">
            {{ routine.site.site_id }} ‚Äî {{ routine.site.street }}, {{ routine.site.city }}, {{ routine.site.state }} {{ routine.site.post_code}}
          </div>
        </div>

        <div class="mb-2">
          <div class="text-muted small">Customer</div>
          <div class="fw-semibold">
            {{ routine.site.customer.customer_name|default:"‚Äî" }}
          </div>
        </div>

        <div class="mb-3">
          <div class="text-muted small">Work Order Number</div>
          <div class="fw-semibold">
            {{ routine.work_order_number|default:"‚Äî" }}
          </div>
        </div>

      </div>

      {# RIGHT COLUMN #}
      <div class="col-md-4">
        <div class="text-muted small mb-1">Service Month</div>

        <form method="post"
              action="{% url 'routines:update_month_due' routine.pk %}"
              id="monthForm"
              class="d-flex gap-2">
          {% csrf_token %}
          <input type="hidden" name="apply_to_all" id="applyToAll" value="0">

          <select class="form-select" name="month_due" id="monthSelect">
            {% for value,label in month_choices %}
              <option value="{{ value }}" {% if routine.month_due == value %}selected{% endif %}>
                {{ label }}
              </option>
            {% endfor %}
          </select>

          <button type="submit" class="btn btn-primary">
            Save
          </button>
        </form>

        <div class="text-muted small mt-1">
          Optionally update all related routines.
        </div>

      </div>

      {# FULL-WIDTH NOTES ROW (spans the entire Routine Details card) #}
      <div class="col-12">
        <hr class="my-3">

        <div class="row g-3">

          <div class="col-12 col-md-4">
            <div class="card h-100 border shadow-sm">
              <div class="card-body py-3">
                <div class="fw-semibold mb-2">Quotation Notes</div>
                <div class="text-muted small">
                  {{ routine.quotation_notes|linebreaksbr|default:"‚Äî" }}
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="card h-100 border shadow-sm">
              <div class="card-body py-3">
                <div class="fw-semibold mb-2">Site Notes</div>
                <div class="text-muted small">
                  {{ routine.site_notes|linebreaksbr|default:"‚Äî" }}
                </div>
              </div>
            </div>
          </div>

          <div class="col-12 col-md-4">
            <div class="card h-100 border shadow-sm">
              <div class="card-body py-3">
                <div class="fw-semibold mb-2">Technician Notes</div>
                <div class="text-muted small">
                  {{ routine.technician_notes|linebreaksbr|default:"‚Äî" }}
                </div>
              </div>
            </div>
          </div>

        </div>
      </div>

    </div>
  </div>
</div>

{# 4-card section: Routine Detail Values (accordion style header) #}
<div class="accordion mb-4" id="routineValuesAccordion">
  <div class="accordion-item">
    <h2 class="accordion-header" id="headingValues">
      <button class="accordion-button fw-semibold" type="button"
              data-bs-toggle="collapse" data-bs-target="#collapseValues"
              aria-expanded="true" aria-controls="collapseValues">
        Routine Detail Values

      </button>
    </h2>

    <div id="collapseValues" class="accordion-collapse collapse show"
         aria-labelledby="headingValues"
         data-bs-parent="#routineValuesAccordion">
      <div class="accordion-body">

        <div class="row g-3">

          <div class="col-12 col-md-6 col-lg-3">
  <div class="card h-100 border shadow-sm">
    <div class="card-body py-3 d-flex flex-column">

      <div>
        <div class="fw-semibold mb-2">Annual</div>

        <div class="d-flex justify-content-between">
          <span class="text-muted">Men Req.</span>
          <strong>{{ routine.annual_men_req|default:"‚Äî" }}</strong>
        </div>

        <div class="d-flex justify-content-between">
          <span class="text-muted">Man Hours</span>
          <strong>{{ routine.annual_man_hours|default:"‚Äî" }}</strong>
        </div>
      </div>

      {# PUSH BUTTON TO BOTTOM #}
      <div class="mt-auto pt-3">
        <a href="{% url 'routines:edit' routine.pk %}"
           class="btn btn-outline-primary w-100">
          Edit Routine Values
        </a>
      </div>

    </div>
  </div>
</div>


          {# Card 2: Half Yearly #}
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 border shadow-sm">
              <div class="card-body py-3">
                <div class="fw-semibold mb-2">Half Yearly</div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Men Req.</span>
                  <strong>{{ routine.half_yearly_men_req|default:"‚Äî" }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Man Hours</span>
                  <strong>{{ routine.half_yearly_man_hours|default:"‚Äî" }}</strong>
                </div>
              </div>
            </div>
          </div>

          {# Card 3: Monthly #}
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 border shadow-sm">
              <div class="card-body py-3">
                <div class="fw-semibold mb-2">Monthly</div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Men Req.</span>
                  <strong>{{ routine.monthly_men_req|default:"‚Äî" }}</strong>
                </div>
                <div class="d-flex justify-content-between">
                  <span class="text-muted">Man Hours</span>
                  <strong>{{ routine.monthly_man_hours|default:"‚Äî" }}</strong>
                </div>
              </div>
            </div>
          </div>

          {# Card 4: Monthly Run / Week + Apply #}
          <div class="col-12 col-md-6 col-lg-3">
            <div class="card h-100 border shadow-sm">
              <div class="card-body py-3">
                <div class="fw-semibold mb-2">Monthly Run / Week</div>

                <form method="post"
                      action="{% url 'routines:apply_monthly_notes_to_all' routine.pk %}"
                      class="d-grid gap-2">
                  {% csrf_token %}

                  <div>
                    <label class="form-label small text-muted mb-1">Run</label>
                    <input type="text" class="form-control"
                           name="monthly_run_notes"
                           value="{{ routine.monthly_run_notes }}"
                           placeholder="e.g. 1">
                  </div>

                  <div>
                    <label class="form-label small text-muted mb-1">Week</label>
                    <input type="text" class="form-control"
                           name="monthly_week_notes"
                           value="{{ routine.monthly_week_notes }}"
                           placeholder="e.g. 4">
                  </div>

                  <button type="submit" class="btn btn-outline-primary w-100">
                    Add to all related routines
                  </button>
                </form>

              </div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>
</div>

{# --- Everything below here is your original Routine Items + totals + JS --- #}

<div class="card shadow-sm mb-4">
  <div class="card-header bg-light fw-semibold d-flex justify-content-between align-items-center">
    <span>Routine Items</span>
  </div>

  <div class="card-body border-bottom bg-light">
    <div class="d-flex justify-content-between align-items-center mb-2">
      <div class="fw-bold">ADD ITEM</div>
      <div class="text-muted small">Choose EFSM code OR type a custom description (won‚Äôt be added to EFSM codes)</div>
    </div>

    <form method="post"
      action="{% url 'routines:add_item' routine.pk %}"
      class="row g-2 align-items-end justify-content-end">

      {% csrf_token %}

      <div class="col-12 col-md-4">
        <label class="form-label small text-muted mb-1">EFSM Code (optional)</label>
        {{ add_item_form.efsm_code }}
        {% if add_item_form.efsm_code.errors %}
          <div class="text-danger small">{{ add_item_form.efsm_code.errors }}</div>
        {% endif %}
      </div>

      <div class="col-12 col-md-4">
        <label class="form-label small text-muted mb-1">Custom Description (optional)</label>
        {{ add_item_form.custom_description }}
        {% if add_item_form.custom_description.errors %}
          <div class="text-danger small">{{ add_item_form.custom_description.errors }}</div>
        {% endif %}
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label small text-muted mb-1">Qty</label>
        {{ add_item_form.quantity }}
        {% if add_item_form.quantity.errors %}
          <div class="text-danger small">{{ add_item_form.quantity.errors }}</div>
        {% endif %}
      </div>

      <div class="col-6 col-md-2">
        <label class="form-label small text-muted mb-1">Unit Price</label>
        {{ add_item_form.unit_price }}
        {% if add_item_form.unit_price.errors %}
          <div class="text-danger small">{{ add_item_form.unit_price.errors }}</div>
        {% endif %}
      </div>

      <div class="col-auto">
        <button type="submit" class="btn btn-sm btn-success">
          + Add Measure
        </button>
      </div>

      {% if add_item_form.non_field_errors %}
        <div class="col-12 mt-2">
          <div class="alert alert-danger py-2 mb-0">
            {{ add_item_form.non_field_errors }}
          </div>
        </div>
      {% endif %}
    </form>
  </div>

  <div class="table-responsive">
    <table class="table table-hover align-middle mb-0">
      <thead class="table-light">
        <tr>
          <th style="width: 130px;">Code</th>
          <th>Description</th>
          <th class="text-end" style="width: 110px;">Qty</th>
          <th class="text-end" style="width: 140px;">Unit Price</th>
          <th class="text-end" style="width: 140px;">Line Total</th>
          <th class="text-center" style="width: 60px;"></th>
        </tr>
      </thead>

      <tbody>
        {% for li in routine.items.all %}
        <tr>
          <td class="fw-semibold">{{ li.display_code }}</td>
          <td>{{ li.display_description }}</td>
          <td class="text-end">{{ li.quantity }}</td>
          <td class="text-end">${{ li.unit_price|floatformat:2 }}</td>
          <td class="text-end">${{ li.line_total|floatformat:2 }}</td>
          <td class="text-center">
            <form method="post"
                  action="{% url 'routines:delete_item' routine.pk li.pk %}"
                  onsubmit="return confirm('Delete this item from the routine?');">
              {% csrf_token %}
              <button type="submit" class="btn btn-sm btn-outline-danger" title="Delete line">
                üóë
              </button>
            </form>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="6" class="text-center text-muted py-3">
            No items.
          </td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <div class="card-footer bg-white">
    <div class="row justify-content-end">
      <div class="col-md-4">
        <div class="d-flex justify-content-between py-1">
          <span class="text-muted">Subtotal</span>
          <strong>${{ subtotal|floatformat:2 }}</strong>
        </div>
        <div class="d-flex justify-content-between py-1">
          <span class="text-muted">GST (10%)</span>
          <strong>${{ gst|floatformat:2 }}</strong>
        </div>
        <hr>
        <div class="d-flex justify-content-between py-1">
          <span class="fw-semibold">Total</span>
          <strong>${{ total|floatformat:2 }}</strong>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
(function () {
  const form = document.getElementById("monthForm");
  const select = document.getElementById("monthSelect");
  const applyToAll = document.getElementById("applyToAll");
  if (!form || !select || !applyToAll) return;

  const original = select.value;

  form.addEventListener("submit", function () {
    applyToAll.value = "0";
    if (select.value !== original) {
      if (confirm("Apply this month change to all related routines?")) {
        applyToAll.value = "1";
      }
    }
  });
})();
</script>

{% endblock %}
