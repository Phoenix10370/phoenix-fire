{% extends "base.html" %}
{% block content %}

<div class="d-flex align-items-center justify-content-between mb-3">
  <div>
    <h1 class="h3 mb-1">{{ job_task.title }}</h1>
  </div>

  <div class="d-flex gap-2 align-items-center">
    <a href="{% url 'job_tasks:edit' job_task.pk %}" class="btn btn-primary">Edit</a>

    <form method="post"
          action="{% url 'job_tasks:delete' job_task.pk %}"
          onsubmit="return confirm('Are you sure you want to delete this Job Task? This cannot be undone.');">
      {% csrf_token %}
      <button type="submit" class="btn btn-outline-danger">Delete</button>
    </form>

    <a href="{% url 'job_tasks:list' %}" class="btn btn-outline-secondary">Back to list</a>
  </div>
</div>

<div class="row g-3">
  <div class="col-lg-8">

    <!-- Tabs -->
    <ul class="nav nav-tabs mb-3">
      <li class="nav-item">
        <button class="nav-link active"
                data-bs-toggle="tab"
                data-bs-target="#tab-details">
          Details
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link"
                data-bs-toggle="tab"
                data-bs-target="#tab-assets">
          Property Assets
        </button>
      </li>
    </ul>

    <div class="tab-content">

      <!-- DETAILS TAB -->
      <div class="tab-pane fade show active" id="tab-details">
        {% include "job_tasks/_jobtask_details_core.html" %}
      </div>

      <!-- PROPERTY ASSETS TAB -->
      <div class="tab-pane fade" id="tab-assets">

        <div class="row g-3">

          <!-- ADD ASSET (FROM JOB TASK) -->
          <div class="col-12 col-lg-5">
            <div class="card shadow-sm">
              <div class="card-header">
                <strong>Add Asset</strong>
              </div>
              <div class="card-body">

                {% if not job_task.site_id %}
                  <div class="alert alert-warning mb-0">
                    This job task has no property linked. Link a property before adding assets.
                  </div>
                {% else %}

                  <form method="post" action="{% url 'job_tasks:add_property_asset' job_task.pk %}">
                    {% csrf_token %}

                    <input type="hidden" name="asset_code_ct_id" value="{{ assetcode_ct_id }}">

                    <div class="mb-3">
                      <label class="form-label"><strong>Category</strong></label>
                      <select id="jt_asset_category" class="form-select">
                        <option value="">-- Select --</option>
                        {% for c in asset_categories %}
                          <option value="{{ c.id }}">{{ c.label }}</option>
                        {% endfor %}
                      </select>
                      {% if not categories_list %}
                        <div class="form-text text-warning">
                          Could not find DropdownList GÇ£Asset CategoriesGÇ¥. Check Settings GåÆ Dropdown Lists.
                        </div>
                      {% endif %}
                    </div>

                    <div class="mb-3">
                      <label class="form-label"><strong>Equipment</strong></label>
                      <select id="jt_asset_equipment" class="form-select" disabled>
                        <option value="">-- Select --</option>
                        {% for e in asset_equipment %}
                          <option value="{{ e.id }}" data-parent="{{ e.parent_id|default_if_none:'' }}">{{ e.label }}</option>
                        {% endfor %}
                      </select>
                      {% if not equipment_list %}
                        <div class="form-text text-warning">
                          Could not find DropdownList GÇ£Asset EquipmentGÇ¥. Check Settings GåÆ Dropdown Lists.
                        </div>
                      {% endif %}
                    </div>

                    <div class="mb-3">
                      <label class="form-label"><strong>Asset Code</strong></label>
                      <select id="jt_asset_code_select" name="asset_code_id" class="form-select" required disabled>
                        <option value="">-- Select --</option>
                        {% for ac in asset_codes %}
                          <option value="{{ ac.id }}"
                                  data-category="{{ ac.category_id }}"
                                  data-equipment="{{ ac.equipment_id }}">
                            {{ ac.code }} GÇö {{ ac.category.label }} / {{ ac.equipment.label }}
                          </option>
                        {% endfor %}
                      </select>
                      <div class="form-text">
                        Select Category GåÆ Equipment GåÆ Asset Code.
                      </div>
                    </div>

                    <hr class="my-3">

                    <div class="mb-3">
                      <label class="form-label"><strong>Block</strong></label>
                      <input type="text" name="block" class="form-control">
                    </div>

                    <div class="mb-3">
                      <label class="form-label"><strong>Level</strong></label>
                      <input type="text" name="level" class="form-control">
                    </div>

                    <div class="mb-3">
                      <label class="form-label"><strong>Location</strong></label>
                      <input type="text" name="location" class="form-control">
                    </div>

                    <div class="mb-3">
                      <label class="form-label"><strong>Optional Fields (JSON)</strong></label>
                      <textarea
                        name="attributes_json"
                        class="form-control"
                        rows="3"
                        placeholder='{"manufacturer":"Tyco","size":"100mm"}'
                      ></textarea>
                      <div class="form-text">
                        Temporary input. Next step: render dropdowns per AssetCode.
                      </div>
                    </div>

                    <button type="submit" class="btn btn-primary">
                      Add Asset
                    </button>

                  </form>

                  <script>
                    (function () {
                      const categoryEl = document.getElementById("jt_asset_category");
                      const equipmentEl = document.getElementById("jt_asset_equipment");
                      const assetCodeEl = document.getElementById("jt_asset_code_select");

                      if (!categoryEl || !equipmentEl || !assetCodeEl) return;

                      const allEquipmentOptions = Array.from(equipmentEl.querySelectorAll("option"))
                        .filter(o => o.value !== "");

                      const allAssetCodeOptions = Array.from(assetCodeEl.querySelectorAll("option"))
                        .filter(o => o.value !== "");

                      function resetSelect(selectEl, placeholderText) {
                        selectEl.value = "";
                        Array.from(selectEl.querySelectorAll("option")).forEach((opt, idx) => {
                          if (idx === 0) {
                            opt.hidden = false;
                          } else {
                            opt.hidden = true;
                          }
                        });
                        if (placeholderText) {
                          selectEl.querySelector("option").textContent = placeholderText;
                        }
                      }

                      function enableSelect(selectEl, enabled) {
                        selectEl.disabled = !enabled;
                      }

                      function filterEquipmentByCategory(categoryId) {
                        resetSelect(equipmentEl, "-- Select --");
                        resetSelect(assetCodeEl, "-- Select --");
                        enableSelect(assetCodeEl, false);

                        if (!categoryId) {
                          enableSelect(equipmentEl, false);
                          return;
                        }

                        let shown = 0;
                        allEquipmentOptions.forEach(opt => {
                          const parent = opt.getAttribute("data-parent") || "";
                          const match = (parent === "" || parent === categoryId);
                          opt.hidden = !match;
                          if (match) shown += 1;
                        });

                        enableSelect(equipmentEl, true);

                        if (shown === 0) {
                          allEquipmentOptions.forEach(opt => opt.hidden = false);
                        }
                      }

                      function filterAssetCodes(categoryId, equipmentId) {
                        resetSelect(assetCodeEl, "-- Select --");

                        if (!categoryId || !equipmentId) {
                          enableSelect(assetCodeEl, false);
                          return;
                        }

                        let shown = 0;
                        allAssetCodeOptions.forEach(opt => {
                          const oc = opt.getAttribute("data-category");
                          const oe = opt.getAttribute("data-equipment");
                          const match = (oc === categoryId && oe === equipmentId);
                          opt.hidden = !match;
                          if (match) shown += 1;
                        });

                        enableSelect(assetCodeEl, true);

                        if (shown === 0) {
                          enableSelect(assetCodeEl, false);
                          assetCodeEl.querySelector("option").textContent = "No Asset Codes for this selection";
                        }
                      }

                      resetSelect(equipmentEl, "-- Select --");
                      resetSelect(assetCodeEl, "-- Select --");
                      enableSelect(equipmentEl, false);
                      enableSelect(assetCodeEl, false);

                      categoryEl.addEventListener("change", function () {
                        filterEquipmentByCategory(categoryEl.value || "");
                      });

                      equipmentEl.addEventListener("change", function () {
                        filterAssetCodes(categoryEl.value || "", equipmentEl.value || "");
                      });
                    })();
                  </script>

                {% endif %}

              </div>
            </div>
          </div>

          <!-- LIST + LINK EXISTING -->
          <div class="col-12 col-lg-7">
            <div class="card mb-3">
              <div class="card-header d-flex justify-content-between">
                <strong>Property Assets</strong>
                <span class="text-muted small">
                  {{ job_task.property_assets.count }} linked
                </span>
              </div>

              <div class="card-body">

                {% if job_task.property_assets.exists %}
                  <div class="table-responsive mb-3">
                    <table class="table table-sm align-middle mb-0">
                      <thead class="table-light">
                        <tr>
                          <th>Asset</th>
                          <th>Block</th>
                          <th>Level</th>
                          <th>Location</th>
                          <th class="text-end"></th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for a in job_task.property_assets.all %}
                          <tr>
                            <td>
                              <strong>{{ a.get_asset_display }}</strong>
                              {% if a.attributes %}
                                <div class="text-muted small">{{ a.attributes }}</div>
                              {% endif %}
                            </td>
                            <td>{{ a.block }}</td>
                            <td>{{ a.level }}</td>
                            <td>{{ a.location }}</td>
                            <td class="text-end">
                              <form method="post"
                                    action="{% url 'job_tasks:unlink_property_asset' job_task.pk a.pk %}"
                                    onsubmit="return confirm('Unlink this asset from the job task?');">
                                {% csrf_token %}
                                <button class="btn btn-sm btn-outline-danger">
                                  Unlink
                                </button>
                              </form>
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="text-muted mb-3">
                    No assets linked yet.
                  </div>
                {% endif %}

                {% if available_property_assets %}
                  <form method="post"
                        action="{% url 'job_tasks:link_property_assets' job_task.pk %}">
                    {% csrf_token %}

                    <label class="form-label"><strong>Link existing property assets</strong></label>

                    {% for a in available_property_assets %}
                      <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               name="asset_ids"
                               value="{{ a.id }}"
                               id="asset{{ a.id }}">
                        <label class="form-check-label" for="asset{{ a.id }}">
                          {{ a.get_asset_display }} GÇö {{ a.location|default:"GÇö" }}
                        </label>
                      </div>
                    {% endfor %}

                    <button class="btn btn-sm btn-outline-primary mt-2">
                      Link selected assets
                    </button>
                  </form>
                {% endif %}

                <hr class="my-3">

                {% if job_task.site_id %}
                  <a href="{% url 'properties:assets' job_task.site_id %}"
                     class="btn btn-sm btn-outline-secondary">
                    Manage assets at property
                  </a>
                {% endif %}

              </div>
            </div>
          </div>

        </div>

      </div>
    </div>
  </div>

  <div class="col-lg-4">
    {% include "job_tasks/_jobtask_sidebar.html" %}
  </div>
</div>

{% endblock %}
